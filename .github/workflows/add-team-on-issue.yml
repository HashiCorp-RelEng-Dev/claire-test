name: Add Team to Repo on Issue Opened

on:
  issues:
    types:
      - opened
      - reopened

jobs:
  add_team_to_repo:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3
      
      - name: Get issue body
        id: issue_info
        run: |
          # Extract the issue body
          ISSUE_BODY=$(jq -r .issue.body $GITHUB_EVENT_PATH)

          # Print the raw issue body to help with debugging
          echo "Raw Issue Body: $ISSUE_BODY"
          
          # Extract the team name using a more robust regex
          echo "team_name=$(echo $ISSUE_BODY | grep -oP '(?<=Team Name:\s*).+')" >> $GITHUB_ENV

      - name: Debug team name
        run: |
            echo "Team name extracted: ${{ env.team_name }}"

      - name: Add team with write access to the repo
        if: ${{ env.team_name != '' }}
        run: |
          curl -X PUT -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"permission": "push"}' \
          "https://api.github.com/orgs/${{ github.repository_owner }}/teams/$TEAM_NAME/repos/${{ github.repository_owner }}/${{ github.repository }}"
        env:
          TEAM_NAME: ${{ env.team_name }}
